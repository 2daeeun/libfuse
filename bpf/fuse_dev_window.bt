BEGIN {
  printf("op,unit,fuse_reads,fuse_writes,fusedev_time_us,total_us\n");
}

/* track /dev/fuse FD opened by daemon (no string in predicates) */
tracepoint:syscalls:sys_enter_openat /comm=="passthrough_hp"/ {
  if (str(args->filename) == "/dev/fuse") { @want_fuse_open = 1; }
}
tracepoint:syscalls:sys_exit_openat /comm=="passthrough_hp" && @want_fuse_open/ {
  if (args->ret >= 0) { @fusefd = (uint64)args->ret; }
  delete(@want_fuse_open);
}
tracepoint:syscalls:sys_enter_openat2 /comm=="passthrough_hp"/ {
  if (str(args->filename) == "/dev/fuse") { @want_fuse_open2 = 1; }
}
tracepoint:syscalls:sys_exit_openat2 /comm=="passthrough_hp" && @want_fuse_open2/ {
  if (args->ret >= 0) { @fusefd = (uint64)args->ret; }
  delete(@want_fuse_open2);
}

/* measurement window: one dd write */
tracepoint:syscalls:sys_enter_write /comm=="dd"/ {
  @t0 = nsecs; @tret = 0;
  @fusedev_us = 0; @fr = 0; @fw = 0;
}
tracepoint:syscalls:sys_exit_write /comm=="dd" && @t0/ { @tret = nsecs; }

/* fuse_dev_do_*: window time on fusedev regardless of splice/read/write */
kprobe:fuse_dev_do_read  /@t0/  { @ts_r = nsecs; @fr++; }
kretprobe:fuse_dev_do_read /@ts_r/ { @fusedev_us += (nsecs - @ts_r)/1000; delete(@ts_r); }

kprobe:fuse_dev_do_write /@t0/  { @ts_w = nsecs; @fw++; }
kretprobe:fuse_dev_do_write /@ts_w/ { @fusedev_us += (nsecs - @ts_w)/1000; delete(@ts_w); }

/* also count data-path syscalls only when they target the tracked /dev/fuse FD */
tracepoint:syscalls:sys_enter_splice /comm=="passthrough_hp" && @fusefd != 0/ {
  /* request: from /dev/fuse (fd_in), reply: to /dev/fuse (fd_out) */
  if ((uint64)args->fd_in  == @fusefd) { @fr++; }
  if ((uint64)args->fd_out == @fusefd) { @fw++; }
}
tracepoint:syscalls:sys_enter_read  /comm=="passthrough_hp" && @fusefd != 0/ {
  if ((uint64)args->fd == @fusefd) { @fr++; }
}
tracepoint:syscalls:sys_enter_write /comm=="passthrough_hp" && @fusefd != 0/ {
  if ((uint64)args->fd == @fusefd) { @fw++; }
}

/* print on Ctrl-C */
END /@t0 && @tret/ {
  printf("WRITE,usec,%d,%d,%llu,%llu\n", @fr, @fw, @fusedev_us, ((uint64)(@tret-@t0))/1000);
}

